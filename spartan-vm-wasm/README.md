# Spartan VM WASM

WebAssembly bindings for the Spartan VM interpreter, allowing you to run Zero-Knowledge proof witness generation in JavaScript/Node.js.

## Building

First, install wasm-pack:

```bash
cargo install wasm-pack
```

Then build the WASM module:

```bash
# For Node.js
wasm-pack build --target nodejs

# For web browsers
wasm-pack build --target web

# For bundlers (webpack, etc.)
wasm-pack build --target bundler
```

## Usage in Node.js

```javascript
import { WasmInterpreter } from './pkg/spartan_vm_wasm.js';
import { readFileSync } from 'fs';

// Create interpreter
const interpreter = new WasmInterpreter();

// Load bytecode (generated by spartan-vm compiler)
const witgenBytecode = readFileSync('path/to/witgen.bin');
interpreter.load_witgen_bytecode(witgenBytecode);

// Load memory layouts
const layoutsJson = readFileSync('path/to/layouts.json', 'utf-8');
interpreter.load_layouts(layoutsJson);

// Execute with inputs (array of field element strings)
const inputs = ["1", "2", "3"];
const result = interpreter.execute_witgen(JSON.stringify(inputs));

console.log('Witness generated:', result.witness_pre_comm.length, 'elements');
```

## Running the Test

```bash
cd nodejs-test
npm run build  # Build WASM module
npm test       # Run test
```

## API

### `WasmInterpreter`

#### Constructor
```javascript
const interpreter = new WasmInterpreter()
```

#### Methods

##### `load_witgen_bytecode(bytes: Uint8Array)`
Load the witness generation bytecode.

##### `load_ad_bytecode(bytes: Uint8Array)`
Load the automatic differentiation bytecode.

##### `load_layouts(layoutsJson: string)`
Load memory layouts from JSON.

##### `execute_witgen(inputsJson: string): Result`
Execute witness generation with the given inputs.

**Parameters:**
- `inputsJson`: JSON string containing array of field elements as decimal strings

**Returns:** Object with:
- `witness_pre_comm`: Array of witness values before commitment
- `witness_post_comm`: Array of witness values after commitment
- `a`, `b`, `c`: R1CS constraint vectors

## File Format

### Bytecode Files
- Binary files containing u64 values in little-endian format
- Generated by `spartan-vm` compiler
- Typically named `witgen.bin` and `ad.bin`

### Layout Files
- JSON format containing memory layout information
- Example:
```json
{
  "witness": {
    "algebraic_size": 1000,
    "multiplicities_size": 100,
    "challenges_size": 10,
    "tables_data_size": 50,
    "lookups_data_size": 20
  },
  "constraints": {
    "algebraic_size": 900,
    "tables_data_size": 45,
    "lookups_data_size": 18
  }
}
```

## Performance Notes

- The WASM build uses `opt-level = "z"` for small binary size
- LTO is enabled for additional optimization
- The branching interpreter is used (WASM-compatible) instead of threaded dispatch
- Manual memory allocation is used (no garbage collector overhead)

## Limitations

- Currently only supports flat field element inputs
- Requires pre-compiled bytecode from the native `spartan-vm` compiler
- No WASM-based compiler yet (compilation happens natively)
